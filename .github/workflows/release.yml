name: Release WhackAMole

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ v1.0.0, v1.2.3 ç­‰æ ¼å¼çš„ tag

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Extract version from tag
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
      - name: Update TOC version
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          sed -i "s/^## Version:.*/## Version: $VERSION/" src/WhackAMole.toc
          
      - name: Package addon
        run: |
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p build/WhackAMole
          
          # å¤åˆ¶ src ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶åˆ° WhackAMole ç›®å½•
          cp -r src/* build/WhackAMole/
          
          # åˆ›å»º zip åŒ…
          cd build
          zip -r WhackAMole-${{ steps.version.outputs.version }}.zip WhackAMole
          cd ..
          
          # éªŒè¯åŒ…å†…å®¹
          echo "Package contents:"
          unzip -l build/WhackAMole-${{ steps.version.outputs.version }}.zip | head -20
          
      - name: Generate changelog
        id: changelog
        run: |
          # è·å–ä¸Šä¸€ä¸ª tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            # å¦‚æœæ²¡æœ‰ä¹‹å‰çš„ tagï¼Œè·å–æ‰€æœ‰æäº¤
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            # è·å–ä¸¤ä¸ª tag ä¹‹é—´çš„æäº¤
            CHANGELOG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          
          # ä¿å­˜åˆ°æ–‡ä»¶
          echo "$CHANGELOG" > changelog.txt
          
          # è¾“å‡ºé¢„è§ˆ
          echo "Changelog preview:"
          head -10 changelog.txt
          
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          release_name: WhackAMole ${{ steps.version.outputs.version }}
          body_path: changelog.txt
          draft: false
          prerelease: false
          
      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./build/WhackAMole-${{ steps.version.outputs.version }}.zip
          asset_name: WhackAMole-${{ steps.version.outputs.version }}.zip
          asset_content_type: application/zip
          
      - name: Release Summary
        run: |
          echo "âœ… Release created successfully!"
          echo "ğŸ“¦ Package: WhackAMole-${{ steps.version.outputs.version }}.zip"
          echo "ğŸ·ï¸ Tag: ${{ steps.version.outputs.tag }}"
          echo "ğŸ”— Release URL: ${{ steps.create_release.outputs.html_url }}"
