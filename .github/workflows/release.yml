name: Release WhackAMole

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ v1.0.0, v1.2.3 ç­‰æ ¼å¼çš„ tag

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Extract version from tag
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
      - name: Update TOC version
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          sed -i "s/^## Version:.*/## Version: $VERSION/" src/WhackAMole.toc
          
      - name: Package addon
        run: |
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p build/WhackAMole
          
          # å¤åˆ¶ src ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶åˆ° WhackAMole ç›®å½•
          cp -r src/* build/WhackAMole/
          
          # åˆ›å»º zip åŒ…
          cd build
          zip -r WhackAMole-${{ steps.version.outputs.version }}.zip WhackAMole
          cd ..
          
          # éªŒè¯åŒ…å†…å®¹
          echo "Package contents:"
          unzip -l build/WhackAMole-${{ steps.version.outputs.version }}.zip | head -20
          
      - name: Generate changelog
        id: changelog
        run: |
          # è·å–ä¸Šä¸€ä¸ª tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            # å¦‚æœæ²¡æœ‰ä¹‹å‰çš„ tagï¼Œè·å–æœ€è¿‘10æ¡æäº¤
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges -10)
          else
            # è·å–ä¸¤ä¸ª tag ä¹‹é—´çš„æäº¤
            CHANGELOG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          
          # ä¿å­˜åˆ°æ–‡ä»¶
          echo "## æ›´æ–°å†…å®¹" > changelog.txt
          echo "" >> changelog.txt
          echo "$CHANGELOG" >> changelog.txt
          echo "" >> changelog.txt
          echo "---" >> changelog.txt
          echo "ğŸ“¦ ä¸‹è½½ \`WhackAMole-${{ steps.version.outputs.version }}.zip\` å¹¶è§£å‹åˆ°é­”å…½ä¸–ç•Œ \`Interface/AddOns\` ç›®å½•" >> changelog.txt
          
          # è¾“å‡ºé¢„è§ˆ
          echo "Changelog preview:"
          cat changelog.txt
          
      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v1
        with:
          name: WhackAMole ${{ steps.version.outputs.version }}
          body_path: changelog.txt
          files: ./build/WhackAMole-${{ steps.version.outputs.version }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Release Summary
        run: |
          echo "âœ… Release created successfully!"
          echo "ğŸ“¦ Package: WhackAMole-${{ steps.version.outputs.version }}.zip"
          echo "ğŸ·ï¸ Tag: ${{ steps.version.outputs.tag }}"
