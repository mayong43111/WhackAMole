# PoC_Talents

## 简介
此 PoC 用于验证在 WotLK (3.3.5) 版本中检测玩家天赋投入情况的逻辑。由于该版本没有直接返回专精 ID 的 API，项目需要通过扫描三个天赋树的投入点数来推断当前专精。

**针对泰坦时光服务器优化**：使用轮询机制检测天赋变化，不依赖标准事件系统。

## 验证的 API
*   `GetActiveTalentGroup()` - 获取当前激活的天赋组 (1 或 2)
*   `GetTalentTabInfo(tabIndex, inspect, isPet, group)` - 获取天赋页信息
*   `GetNumTalents(tabIndex)` - 获取指定天赋页的天赋数量
*   `GetTalentInfo(tab, index, inspect, isPet, group)` - 获取具体天赋点信息

## 实现机制

### 1. 轮询检测系统
由于泰坦服务器未正确实现 `ACTIVE_TALENT_GROUP_CHANGED` 事件，插件使用 OnUpdate 轮询机制：
- **检测频率**：每 2 秒检查一次天赋状态
- **检测方法**：构建天赋状态字符串 (格式: `G1:0000...|0000...|0000...`)
- **触发条件**：当状态字符串发生变化时，延迟 1 秒后执行完整扫描

### 2. C_Timer 兼容层
针对 3.3.5 客户端实现了 C_Timer.After() 的 polyfill，使用 OnUpdate 模拟延迟执行。

### 3. 深度扫描与重试
- 检测到天赋数据未就绪时（numTalents == 0 或 maxRank == nil）自动重试
- 验证每个天赋节点的完整性
- 构建导出字符串格式：`rank1rank2...rankN-rank1rank2...rankM-...`（三个专精用 `-` 分隔）

## 使用方法
1.  进入游戏
2.  插件会在登录 2 秒后自动扫描并启动轮询系统
3.  切换双天赋后，**2 秒内**自动检测并打印新的天赋信息
4.  手动命令：`/poctalent` - 立即重新扫描天赋

## 预期输出示例
```
[PoC_Talents] 插件加载完成
PoC_Talents: 开始扫描天赋数据...
当前天赋组 (Active Group): 1
天赋页 1 (武器): 投入点数 18
  -> 深度扫描统计点数: 18
天赋页 2 (狂怒): 投入点数 53
  -> 深度扫描统计点数: 53
天赋页 3 (防护): 投入点数 0
  -> 深度扫描统计点数: 0
PoC_Talents: 扫描完成.
导出字串: 302203301000000000000000000000-05005203251521333301351000000000000-00000000000000000000000000000000000
[PoC_Talents] 启动天赋变化轮询检测（每2秒）

[切换天赋后]
[PoC_Talents] 检测到天赋变化（轮询检测）
PoC_Talents: 开始扫描天赋数据...
当前天赋组 (Active Group): 2
...
```

## 技术要点
- ✅ 兼容泰坦时光私服（不依赖未实现的事件）
- ✅ 轻量级轮询（2秒间隔，快速字符串比对）
- ✅ 自动重试机制（数据未就绪时）
- ✅ 完整的天赋导出字符串
